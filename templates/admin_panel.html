<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Panel Admin · Transportistas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
      --brand:#1e40af; --brand-2:#2563eb; --ring:#e5e7eb; --radius:16px;
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    }
    *{ box-sizing:border-box }
    html,body{
      margin:0; padding:0; background:var(--bg); color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      -webkit-text-size-adjust:100%;
    }
    .wrap{ max-width:1200px; margin:28px auto; padding:0 16px; overflow:clip; }
    .header{ display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; margin-bottom:16px; }
    .header h1{ margin:0; font-size:28px }
    .actions{ display:flex; gap:8px; flex-wrap:wrap }
    .btn{
      min-height:36px; padding:8px 14px; border-radius:10px; cursor:pointer;
      border:1px solid var(--brand-2); background:var(--brand-2); color:#fff; font-weight:600; text-decoration:none;
      display:inline-flex; align-items:center; gap:6px;
    }
    .btn.outline{ background:#fff; color:var(--brand-2); }
    .card{
      background:var(--card); border-radius:var(--radius);
      box-shadow:0 1px 2px rgba(15,23,42,.06), 0 6px 14px rgba(2,6,23,.04);
      display:flex; flex-direction:column; min-width:0;
      border:1px solid var(--ring);
    }
    .card-h{ padding:14px 16px; border-bottom:1px solid var(--ring); display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }
    .card-h h3{ margin:0; font-size:18px }
    .card-b{ padding:14px 16px; display:flex; flex-direction:column; gap:10px; }
    .grid{ display:grid; gap:16px }
    .grid-top{ grid-template-columns:1.2fr 1fr; }
    .grid-bottom{ grid-template-columns:1fr 1fr; }
    @media (max-width:1000px){ .grid-top,.grid-bottom{ grid-template-columns:1fr } }

    /* Tablas */
    .table-wrap{ overflow:auto; -webkit-overflow-scrolling:touch; }
    table{ width:100%; border-collapse:separate; border-spacing:0; }
    th,td{ padding:10px 12px; border-bottom:1px solid var(--ring); font-size:14px; text-align:left; white-space:nowrap; }
    th{ color:var(--muted); background:#fafbff; font-weight:600; position:sticky; top:0; }
    tr:last-child td{ border-bottom:none; }
    .sub{ color:var(--muted); font-size:12px }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; }
    .pill.ok{ background:#e9f9f2; color:#0d7a5a; }
    .pill.warn{ background:#fff3d6; color:#8a5a07; }
    .pill.bad{ background:#ffe4e4; color:#8a1a1a; }

    /* Form alta */
    .form-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px }
    @media (max-width:700px){ .form-grid{ grid-template-columns:1fr } }
    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:6px }
    .in{ width:100%; min-height:36px; padding:8px 10px; border-radius:10px; border:1px solid var(--ring); background:#fff; }

    /* Flash */
    .flash-container { text-align:center; margin:10px 0; }
    .flash{ display:inline-block; padding:12px 18px; border-radius:8px; margin:6px auto; font-weight:600; max-width:700px; }
    .flash-success{ background:#d4edda; color:#155724; }
    .flash-error{ background:#f8d7da; color:#721c24; }
    .flash-info{ background:#d1ecf1; color:#0c5460; }
    th.center, td.center { text-align: center; }
  </style>

  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="flash-container" id="flashes">
      {% for category, message in messages %}
        <div class="flash flash-{{ 'success' if category in ['ok','success'] else ('error' if category in ['error','danger'] else 'info') }}">{{ message }}</div>
      {% endfor %}
    </div>
    <script>
      for (const el of document.querySelectorAll('#flashes .flash')) {
        setTimeout(() => el.remove(), 4500);
        el.addEventListener('click', () => el.remove());
      }
    </script>
  {% endif %}
  {% endwith %}
</head>
<body>
  <div class="wrap">
    <div class="header">
      <h1>Administración</h1>
      <div class="actions">
        <a class="btn" href="{{ url_for('admin_export') }}">Descargar historial (.xlsx)</a>

        <!-- Cambio de contra comentado -->
        <!-- <a href="{{ url_for('change_password') }}">Cambiar contraseña</a> Cambio de contra comentado -->
        <a class="btn" href="{{ url_for('logout') }}">Cerrar sesión</a>
      </div>
    </div>

    <!-- Fila superior: Alta rápida + Resumen transportistas -->
    <div class="grid grid-top" style="margin-bottom:16px;">
      <!-- Alta rápida de usuario -->
      <div class="card">
        <div class="card-h"><h3>Alta rápida de usuario</h3></div>
        <div class="card-b">
          <form method="post" action="{{ url_for('create_user') }}" class="form-grid">
            <div>
              <label>Usuario</label>
              <input class="in" type="text" name="username" placeholder="Ej.: juan.perez" required>
            </div>
            <div>
              <label>Clave</label>
              <input class="in" type="password" name="password" placeholder="********" required>
            </div>
            <div>
              <label>Tipo</label>
              <select class="in" name="tipo" required>
                <option value="transportista">Transportista</option>
                <option value="arenera">Arenera</option>
              </select>
            </div>
            <div style="display:flex; align-items:flex-end; justify-content:flex-end;">
              <button class="btn" type="submit">Crear</button>
            </div>
          </form>
        </div>
      </div>

      <!-- Resumen rápido (hoy) con links -->
      <div class="card">
        <div class="card-h"><h3>Accesos</h3></div>
        <div class="card-b" style="gap:8px;">
          <a class="btn outline" href="{{ url_for('admin_dashboard') }}">Dashboard</a>
          <a class="btn outline" href="{{ url_for('todos_camiones') }}">Historial camiones</a>
          <a class="btn outline" href="{{ url_for('password_log') }}">Cambios de contraseña</a>
        </div>
      </div>
    </div>

    <!-- Fila inferior: tablas -->
    <div class="grid grid-bottom">
    <!-- Transportistas -->
    <div class="card">
      <div class="card-h"><h3>Transportistas</h3></div>
      <div class="card-b">
        {% if transportistas %}
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Usuario</th>
                <th style="text-align:center;">Envíos</th>
                <th style="text-align:center;">Cupo semana</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for r in transportistas %}
              <tr>
                <td>{{ r.t.username }}</td>
                <td style="text-align:center;">{{ r.sent }}</td>
                <td style="text-align:center;">
                  {% if r.quota and r.quota > 0 %}
                    <span class="pill ok">{{ r.quota }}</span>
                  {% else %}
                    <span class="pill warn">0</span>
                  {% endif %}
                </td>
                <td style="display:flex; gap:8px;">
                  <a class="btn outline" href="{{ url_for('manage_quotas', transportista_id=r.t.id) }}">Cuotas</a>
                  <a class="btn outline" href="{{ url_for('todos_camiones') }}?transportista={{ r.t.username }}">Viajes</a>
                  <a class="btn outline" href="{{ url_for('delete_user', user_id=r.t.id) }}" onclick="return confirm('¿Eliminar transportista {{ r.t.username }}?');">X</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <div class="sub">No hay transportistas cargados.</div>
        {% endif %}
      </div>
    </div>

    <!-- Areneras -->
    <div class="card">
      <div class="card-h"><h3>Areneras</h3></div>
      <div class="card-b">
        {% if areneras %}
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Usuario</th>
                <th style="text-align:center;">Envíos recibidos</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for r in areneras %}
              <tr>
                <td>{{ r.a.username }}</td>
                <td style="text-align:center;">{{ r.shipments }}</td>
                <td style="display:flex; gap:8px;">
                  <a class="btn outline" href="{{ url_for('todos_camiones') }}?arenera={{ r.a.username }}">Viajes</a>
                  <a class="btn outline" href="{{ url_for('delete_user', user_id=r.a.id) }}" onclick="return confirm('¿Eliminar arenera {{ r.a.username }}?');">X</a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <div class="sub">No hay areneras cargadas.</div>
        {% endif %}
      </div>
    </div>
    </div>
  </div>
</body>
</html>
