<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Historial · Basculista</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
      --brand:#1e40af; --brand-2:#2563eb; --ring:#e5e7eb; --radius:16px;
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    }
    *{ box-sizing:border-box }
    html,body{
      margin:0; padding:0; background:var(--bg); color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial;
      -webkit-text-size-adjust:100%;
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:16px 12px 90px; }

    /* header */
    .top{ display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap; }
    .hello{ display:flex; flex-direction:column; }
    .hello h1{ margin:0; font-size:18px }
    .hello .sub{ color:var(--muted); font-size:12px }
    .btn, .btn-sm, .btn-icon{
      border:1px solid var(--brand-2); color:#fff; background:var(--brand-2);
      border-radius:12px; padding:10px 12px; font-weight:800; text-decoration:none;
    }
    .btn-sm{ padding:8px 10px }
    .btn.outline{ background:#fff; color:var(--brand-2) }
    .btn-icon{ display:inline-flex; align-items:center; justify-content:center; min-width:44px; padding:8px 10px }

    /* filtros sticky */
    .filters{
      position:sticky; top:0; z-index:5; margin-top:12px;
      background:linear-gradient(#f5f7fb 60%, rgba(245,247,251,.9));
      border-bottom:1px solid var(--ring);
    }
    .card{
      background:var(--card); border-radius:var(--radius);
      border:1px solid var(--ring); box-shadow:0 1px 2px rgba(15,23,42,.06),0 6px 14px rgba(2,6,23,.04);
      padding:10px; margin-bottom:12px;
    }
    .row{ display:flex; gap:8px; align-items:end; flex-wrap:wrap }
    label{ font-size:12px; color:var(--muted); display:block; margin:0 2px 6px }
    .in{ min-height:40px; padding:10px 12px; border-radius:12px; border:1px solid var(--ring); background:#fff; color:var(--ink); }
    .in:focus{ outline:none; border-color:#b5c8ff; box-shadow:0 0 0 3px rgba(37,99,235,.15) }
    .grow{ flex:1 1 220px }

    .chips{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .chip{
      padding:8px 12px; border-radius:999px; border:1px solid var(--ring); background:#fff; color:var(--ink);
      font-weight:700; text-decoration:none; display:inline-flex; gap:6px; align-items:center;
    }
    .chip.active{ border-color:var(--brand-2); box-shadow:0 0 0 3px rgba(37,99,235,.15) }
    .count{ font-size:12px; color:var(--muted) }

    /* lista cards + tabla desktop */
    .list{ display:none; flex-direction:column; gap:10px }
    .item{ display:grid; grid-template-columns:8px 1fr auto; gap:10px; align-items:center; background:#fff; border:1px solid var(--ring); border-radius:14px; padding:10px }
    .band.ok{ background:#10b981 } .band.warn{ background:#f59e0b } .band.bad{ background:#ef4444 }
    .title{ font-weight:800 }
    .meta{ color:var(--muted); font-size:12px; margin-top:2px }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px }
    .pill.ok{ background:#e9f9f2; color:#0d7a5a; border:1px solid #cfeee1 }
    .pill.warn{ background:#fff3d6; color:#8a5a07; border:1px solid #ffe7a3 }
    .pill.bad{ background:#ffe4e4; color:#8a1a1a; border:1px solid #f7c2c2 }

    /* ID badge style */
    .id-badge { color:var(--brand-2); margin-right:4px; font-weight:900; }

    .table-wrap{ overflow:auto; -webkit-overflow-scrolling:touch }
    table{ width:100%; border-collapse:separate; border-spacing:0 }
    th, td{ padding:10px 8px; border-bottom:1px solid var(--ring); font-size:14px; white-space:nowrap; text-align:left }
    th{ color:var(--muted); background:#fafbff; position:sticky; top:0; z-index:1 }
    td.center, th.center{ text-align:center }

    /* responsive: móviles usan cards, desktop usa tabla */
    @media (max-width:820px){
      .list{ display:flex }
      .table-wrap{ display:none }
    }
    .btn-sm{ padding:6px 10px; border:1px solid var(--brand-2); background:#fff; color:var(--brand-2); border-radius:10px; cursor:pointer; }
    .btn-sm.outline{ background:#fff; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; }
    .pill.ok{ background:#E8F8EF; color:#0A7C4A; }
    .pill.warn{ background:#FFF2DA; color:#8A5400; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="hello">
        <h1>Historial</h1>
        <div class="sub">{{ user.username }}</div>
      </div>
      <div class="row" style="align-items:center;">
        <a class="btn outline" href="{{ url_for('arenera_export', start=start_date, end=end_date) }}">⬇️</a>
        <a class="btn-sm" href="{{ url_for('logout') }}">Cerrar sesión</a>
      </div>
    </div>

    <div class="filters">
      <div class="card">
        <form method="get" action="{{ url_for('arenera_history') }}">
          <div class="row">
            <div>
              <label>Desde</label>
              <input class="in" type="date" name="start_date" value="{{ start_date }}">
            </div>
            <div>
              <label>Hasta</label>
              <input class="in" type="date" name="end_date" value="{{ end_date }}">
            </div>
            <div class="grow">
              <label>Buscar</label>
              <input class="in" type="text" name="search" placeholder="#ID, Chofer, DNI, Remito..." value="{{ search or '' }}">
            </div>
            <div>
              <label>&nbsp;</label>
              <button class="btn" type="submit">Aplicar</button>
            </div>
          </div>

          <div class="row" style="align-items:center; margin-top:8px;">
            <div class="chips">
              {% set cur = status or '' %}
              <a class="chip {{ 'active' if cur=='' else '' }}" href="{{ url_for('arenera_history', start_date=start_date, end_date=end_date, search=search) }}">
                Todos <span class="count">({{ counts.total }})</span>
              </a>
              <a class="chip {{ 'active' if cur=='En viaje' else '' }}" href="{{ url_for('arenera_history', start_date=start_date, end_date=end_date, search=search, status='En viaje') }}">
                En viaje <span class="count">({{ counts.en_viaje }})</span>
              </a>
              <a class="chip {{ 'active' if cur=='Llego' else '' }}" href="{{ url_for('arenera_history', start_date=start_date, end_date=end_date, search=search, status='Llego') }}">
                Llegados <span class="count">({{ counts.llegados }})</span>
              </a>
            </div>
          </div>
        </form>
      </div>
    </div>

    <div class="list">
      {% if shipments %}
        {% for s in shipments %}
        <div class="item">
          <div class="band {{ 'ok' if s.status=='Llego' else ('warn' if s.status=='En viaje' else 'bad') }}"></div>
          <div>
            <div class="title">
              <span class="id-badge">#{{ s.id }}</span>
              {{ s.chofer }} · DNI {{ s.dni }}
            </div>
            <div class="meta">
              {{ s.date.strftime('%d/%m/%Y') if s.date else s.date }} · {{ s.transportista.username if s.transportista else '—' }} · {{ s.tipo }}
              · Tractor: {{ s.tractor }} · Batea: {{ s.trailer }}
            </div>
            {% if s.remito_arenera or s.peso_neto_arenera %}
            <div class="meta" style="color:var(--ink); font-weight:500;">
              Remito: {{ s.remito_arenera or '—' }} | Tn: {{ ('%.2f' % s.peso_neto_arenera).replace('.', ',') if s.peso_neto_arenera else '—' }}
            </div>
            {% endif %}
          </div>
          <div>
            {% if s.status == 'Llego' %}
              <span class="pill ok">Llegó</span>
            {% elif s.status == 'En viaje' %}
              <span class="pill warn">En viaje</span>
            {% else %}
              <span class="pill warn"></span>
            {% endif %}
          </div>
        </div>
        {% endfor %}
      {% else %}
        <div class="card" style="text-align:center; color:var(--muted);">Sin resultados para este filtro.</div>
      {% endif %}
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>ID</th> <th>Fecha</th>
            <th>Transportista</th>
            <th>Chofer</th>
            <th>DNI</th>
            <th>Tractor</th>
            <th>Batea</th>
            <th>Remito</th> <th>Tn</th>     <th class="center">Estado</th>
          </tr>
        </thead>
        <tbody>
          {% for s in shipments %}
          <tr>
            <td><strong style="color:var(--brand-2);">#{{ s.id }}</strong></td>
            <td>{{ s.date.strftime('%d/%m/%Y') if s.date else s.date }}</td>
            <td>{{ s.transportista.username if s.transportista else '—' }}</td>
            <td>{{ s.chofer }}</td>
            <td>{{ s.dni }}</td>
            <td>{{ s.tractor }}</td>
            <td>{{ s.trailer }}</td>
            <td>{{ s.remito_arenera or '—' }}</td>
            <td>{{ ('%.2f' % s.peso_neto_arenera).replace('.', ',') if s.peso_neto_arenera else '—' }}</td>
            <td>
              {% if s.status == 'Llego' %}
                <span class="pill ok">Llegó</span>
                <form method="post"
                      action="{{ url_for('arenera_update', shipment_id=s.id) }}"
                      style="display:inline-block; margin-left:8px"
                      onsubmit="return confirm('¿Volver a estado En Viaje?');">
                  <input type="hidden" name="status" value="En viaje">
                  <button type="submit" class="btn-sm outline" title="Marcar como En viaje">↩️</button>
                </form>
              {% elif s.status == 'En viaje' %}
                <span class="pill warn">En viaje</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>

  <nav class="nav" style="position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid var(--ring); display:flex; justify-content:space-around; padding:8px 10px; z-index:10;">
    <a href="{{ url_for('arenera_panel') }}" style="flex:1; text-align:center; color:var(--brand-2); text-decoration:none; font-weight:700; padding:10px 8px; border-radius:10px;">Inicio</a>
    <a href="{{ url_for('arenera_history') }}" class="active" style="flex:1; text-align:center; color:var(--brand-2); text-decoration:none; font-weight:700; padding:10px 8px; border-radius:10px; background:#eef2ff;">Historial</a>
  </nav>
</body>
</html>