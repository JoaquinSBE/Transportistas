<!doctype html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Llegadas | SBE</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root {
      --bs-font-sans-serif: "Inter", sans-serif;
      --bs-primary: #2563eb;
      --bs-body-bg: #f3f4f6;
      --card-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --card-radius: 12px;
    }

    body {
      font-family: var(--bs-font-sans-serif);
      background-color: var(--bs-body-bg);
      min-height: 100vh;
    }

    .navbar-glass {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid #e5e7eb;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .card-custom {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: var(--card-radius);
      box-shadow: var(--card-shadow);
      overflow: hidden;
    }

    .card-header-custom {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid #f3f4f6;
      background-color: #fff;
    }

    .card-body {
      padding: 1.1rem 1.25rem 1.25rem 1.25rem;
    }

    .muted {
      color: #6b7280;
      font-size: 0.9rem;
    }

    .info-box {
      border: 1px dashed #c7d2fe;
      background: #eff6ff;
      color: #1f2937;
      border-radius: 10px;
      padding: 0.75rem 0.9rem;
      font-size: 0.85rem;
    }

    .btn-primary {
      font-weight: 600;
    }

    .form-control,
    .form-select {
      border-radius: 8px;
      padding: 0.6rem 0.8rem;
      border: 1px solid #d1d5db;
      font-size: 0.9rem;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--bs-primary);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .loading-indicator {
      display: inline-block;
      width: 0.95rem;
      height: 0.95rem;
      border: 2px solid #bfdbfe;
      border-top-color: #2563eb;
      border-radius: 50%;
      animation: spin .8s linear infinite;
      vertical-align: -2px;
      margin-right: 0.4rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-glass mb-4">
    <div class="container">
      <span class="navbar-brand mb-0 h1 fw-bold text-dark">
        <i class="fa-solid fa-location-dot text-primary me-2"></i>Turno de Llegada
      </span>
    </div>
  </nav>

  <main class="container pb-4">
    <div class="row justify-content-center">
      <div class="col-lg-6 col-md-8">
        {% if wa_notice %}
        <div class="alert alert-warning">{{ wa_notice }}</div>
        {% endif %}
        <div class="card-custom">
          <div class="card-header-custom">
            <h1 class="h5 mb-1">Registro por geolocalizacion</h1>
            <p class="muted mb-0">Ingrese DNI y planta. Debe estar dentro del radio habilitado.</p>
          </div>
          <div class="card-body p-4">
            <form id="checkin-form" class="row g-3" novalidate>
              <input type="hidden" id="csrf_token" value="{{ csrf_token() }}">
              <input type="hidden" id="wa_token" value="{{ (prefill.wa_token if prefill else '') }}">
              <div class="col-12">
                <label for="dni" class="form-label fw-medium">DNI</label>
                <input type="text" id="dni" class="form-control" placeholder="Ej: 32123456" inputmode="numeric" value="{{ (prefill.dni if prefill else '') }}" required>
              </div>
              <div class="col-12">
                <label for="plant" class="form-label fw-medium">Planta</label>
                <select id="plant" class="form-select" required>
                  <option value="" {{ '' if (prefill and prefill.plant) else 'selected' }} disabled>Seleccionar planta</option>
                  {% for code, p in plants.items() %}
                  <option value="{{ code }}" {{ 'selected' if (prefill and prefill.plant == code) else '' }}>{{ p.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-12">
                <div class="info-box mb-3">
                  <i class="fa-solid fa-circle-info me-1 text-primary"></i>
                  Active la ubicacion del navegador para poder tomar turno.
                </div>
                <button type="submit" class="btn btn-primary w-100" id="btn-submit">
                  <i class="fa-solid fa-ticket me-1"></i>Tomar turno
                </button>
              </div>
            </form>

            <div id="result" class="mt-3"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    (function () {
      const form = document.getElementById("checkin-form");
      const result = document.getElementById("result");
      const btn = document.getElementById("btn-submit");

      function showMessage(message, type) {
        result.className = `alert alert-${type} mb-0`;
        result.innerHTML = message;
      }

      function showError(message) {
        showMessage(message, "danger");
      }

      function formatExpiry(isoText) {
        if (!isoText) return "-";
        const d = new Date(isoText);
        if (Number.isNaN(d.getTime())) return isoText;
        return d.toLocaleString();
      }

      form.addEventListener("submit", function (ev) {
        ev.preventDefault();

        const dni = (document.getElementById("dni").value || "").trim();
        const plant = (document.getElementById("plant").value || "").trim();
        const csrfToken = document.getElementById("csrf_token").value;
        const waToken = (document.getElementById("wa_token").value || "").trim();

        if (!dni || !plant) {
          showError("Complete DNI y planta.");
          return;
        }
        if (!navigator.geolocation) {
          showError("Este navegador no permite geolocalizacion.");
          return;
        }

        btn.disabled = true;
        showMessage('<span class="loading-indicator"></span>Obteniendo ubicacion...', "info");

        navigator.geolocation.getCurrentPosition(async function (pos) {
          const payload = {
            dni: dni,
            plant: plant,
            lat: pos.coords.latitude,
            lon: pos.coords.longitude,
            accuracy: pos.coords.accuracy,
            wa_token: waToken
          };

          try {
            const resp = await fetch("/api/llegadas/checkin", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrfToken
              },
              credentials: "same-origin",
              body: JSON.stringify(payload)
            });

            const data = await resp.json().catch(() => ({}));
            if (!resp.ok || !data.ok) {
              showError(data.error || "No se pudo registrar la llegada.");
              return;
            }

            const aheadCount = Number.isFinite(Number(data.ahead_count))
              ? Math.max(0, Number(data.ahead_count))
              : Math.max(0, Number((data.queue_position || 1) - 1));
            const queue = `Camiones delante: <strong>${aheadCount}</strong><br>`;
            const expiry = data.expires_at
              ? `Vence: <strong>${formatExpiry(data.expires_at)}</strong>`
              : "Tiempo de espera: <strong>empieza cuando te llamen</strong>";

            showMessage(
              `Turno registrado.<br>
              ID: <strong>${data.arrival_id}</strong><br>
              Estado: <strong>${data.status}</strong><br>
              ${queue}
              ${expiry}`,
              "success"
            );
          } catch (err) {
            showError("Error de red al registrar la llegada.");
          } finally {
            btn.disabled = false;
          }
        }, function () {
          btn.disabled = false;
          showError("No se pudo obtener la ubicacion del dispositivo.");
        }, {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        });
      });
    })();
  </script>
</body>
</html>
