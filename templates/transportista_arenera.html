<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>{{ assignment.arenera.username }} · Cargar viaje</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <style>
    :root{
      --bg:#f5f7fb; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
      --brand:#1e40af; --brand-2:#2563eb; --ring:#e5e7eb; --radius:16px;
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
    }
    *{ box-sizing:border-box }
    html,body{ margin:0; padding:0; background:var(--bg); color:var(--ink);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; -webkit-text-size-adjust:100%; }
    .wrap{ max-width:760px; margin:0 auto; padding:16px 12px 80px; }

    .top{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .hello{ display:flex; flex-direction:column; }
    .hello h1{ margin:0; font-size:18px; }
    .hello .sub{ color:var(--muted); font-size:12px; }
    .btn-sm{ padding:8px 10px; border-radius:10px; border:1px solid var(--ring); background:#fff; color:var(--brand-2); text-decoration:none; font-weight:600; }

    .card{ background:var(--card); border-radius:var(--radius);
      border:1px solid var(--ring); box-shadow:0 1px 2px rgba(15,23,42,.06),0 6px 14px rgba(2,6,23,.04);
      margin-top:12px; padding:12px; }
    .sec-h{ display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:6px; }
    .sec-h h2{ margin:0; font-size:16px; }
    .sub{ color:var(--muted); font-size:12px; }

    .bar{ height:8px; width:100%; background:#eef2ff; border:1px solid var(--ring); border-radius:8px; overflow:hidden; }
    .bar > span{ display:block; height:100%; background:linear-gradient(90deg, var(--brand-2), #7aa7ff); width:0%; }

    /* Form */
    label{ font-size:12px; color:var(--muted); display:block; margin:8px 2px 6px; }
    .in{ width:100%; min-height:44px; padding:10px 12px; border-radius:12px; border:1px solid var(--ring); background:#fff; color:var(--ink); }
    .in:focus{ outline:none; border-color:#b5c8ff; box-shadow:0 0 0 3px rgba(37,99,235,.15); }
    .row{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width:560px){ .row.two{ grid-template-columns:1fr 1fr; } }
    .seg{ display:flex; gap:8px; }
    .seg button{
      flex:1; min-height:44px; border:1px solid var(--ring); background:#fff; color:var(--ink);
      border-radius:12px; font-weight:700; cursor:pointer;
    }
    .seg button.active{ border-color:var(--brand-2); box-shadow:0 0 0 3px rgba(37,99,235,.15); }

    .btn{ width:100%; min-height:46px; padding:12px; border-radius:12px; border:1px solid var(--brand-2);
      background:var(--brand-2); color:#fff; font-weight:800; }
    .btn[disabled]{ opacity:.5; pointer-events:none; }

    /* Lista de viajes */
    .list{ display:flex; flex-direction:column; gap:8px; }
    .trip{ border:1px solid var(--ring); border-radius:12px; background:#fff; padding:10px; }
    .rowflex{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
    .t-title{ font-weight:700; }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; }
    .pill.ok{ background:#e9f9f2; color:#0d7a5a; border:1px solid #cfeee1; }
    .pill.warn{ background:#fff3d6; color:#8a5a07; border:1px solid #ffe7a3; }
    .pill.bad{ background:#ffe4e4; color:#8a1a1a; border:1px solid #f7c2c2; }
    .meta{ color:var(--muted); font-size:12px; margin-top:4px; }
    .icon-btn{ border:1px solid var(--ring); background:#fff; color:#b91c1c; border-radius:10px; padding:6px 10px; font-weight:700; cursor:pointer; }
    .icon-btn:hover{ background:#fff5f5; }

    /* navbar inferior */
    .nav{ position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid var(--ring);
      display:flex; justify-content:space-around; padding:8px 10px; z-index:10; }
    .nav a{ flex:1; text-align:center; color:var(--brand-2); text-decoration:none; font-weight:700; padding:10px 8px; border-radius:10px; }
    .nav a.active{ background:#eef2ff; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="hello">
        <h1>{{ assignment.arenera.username }}</h1>
        <div class="sub">Fecha: {{ date.strftime('%d/%m/%Y') }}</div>
      </div>
      <a class="btn-sm" href="{{ url_for('transportista_panel') }}">Volver</a>
    </div>
    
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flashes" style="margin-top:10px;">
          {% for category, message in messages %}
            <div class="flash {{ 'success' if category in ['success','ok'] else 'error' }}" 
                 style="padding:12px 14px; border-radius:12px; font-size:14px; font-weight:600; border:1px solid transparent; cursor:pointer;">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% set used = used or 0 %}
    {% set lim  = limit or 0 %}
    {% set pct  = 0 if lim == 0 else (100*used//lim if used <= lim else 100) %}
    <div class="card">
      <div class="sec-h">
        <h2>Cupo de hoy</h2>
        <div class="sub">{{ used }} / {{ lim }} usados</div>
      </div>
      <div class="bar"><span style="width:{{ pct }}%"></span></div>
    </div>

    <div class="card">
      <div class="sec-h"><h2>Cargar viaje</h2></div>
      <form method="post" action="">
        <div class="row">
          <div>
            <label>DNI</label>
            <input class="in" type="text" name="dni" id="dni-input" inputmode="numeric" pattern="[0-9]*" placeholder="44554990" required>
          </div>
          <div>
            <label>Nombre y apellido del chofer</label>
            <input class="in" type="text" name="nombre_apellido" id="nombre-input" placeholder="Juan Pérez" required>
          </div>
        </div>

        <div class="row two">
          <div>
            <label>Género</label>
            <div class="seg" data-name="gender" id="gender-seg">
              <button type="button" data-val="M" class="active">M</button>
              <button type="button" data-val="F">F</button>
            </div>
            <input type="hidden" name="gender" value="M" id="gender-input">
          </div>
          <div>
            <label>Tipo</label>
            <select class="in" name="tipo" id="tipo-select" required>
              <option value="">Tipo…</option>
              <option value="Batea">Batea</option>
              <option value="Bivuelco">Bivuelco</option>
            </select>
          </div>
        </div>

        <div class="row two">
          <div>
            <label>Patente tractor</label>
            <input class="in pat" type="text" name="patente_tractor" id="tractor-input" placeholder="AA123BB" required>
          </div>
          <div>
            <label>Patente batea</label>
            <input class="in pat" type="text" name="patente_batea" id="trailer-input" placeholder="AB123CD" required>
          </div>
        </div>

        <div style="margin-top:10px;">
          <button class="btn" type="submit" {{ 'disabled' if lim==0 or used>=lim else '' }}>
            {{ 'Sin cupo' if lim==0 or used>=lim else 'Agregar envío' }}
          </button>
        </div>
      </form>
    </div>

    <div class="card">
      <div class="sec-h"><h2>Mis viajes de hoy</h2></div>
      {% if shipments and shipments|length %}
        <div class="list">
          {% for s in shipments %}
          <div class="trip">
            <div class="rowflex">
              <div class="t-title">{{ s.chofer }} · {{ s.dni }}</div>
              <div class="actions">
                {% if s.status == 'Llego' %}
                  <span class="pill ok">Llegó</span>
                {% elif s.status == 'En viaje' %}
                  <span class="pill warn">En viaje</span>
                  <form method="post" action="" onsubmit="return confirm('¿Eliminar este viaje?');" style="display:inline;">
                    <input type="hidden" name="delete_id" value="{{ s.id }}">
                    <button class="icon-btn" type="submit" title="Eliminar">✕</button>
                  </form>
                {% else %}
                  <span class="pill warn"></span>
                {% endif %}
              </div>
            </div>
            <div class="meta">
              {{ s.tipo }} · Tractor: {{ s.tractor }} · Batea: {{ s.trailer }}
            </div>
          </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="sub">Aún no cargaste viajes hoy.</div>
      {% endif %}
    </div>
  </div>

  <nav class="nav">
    <a href="{{ url_for('transportista_panel') }}">Inicio</a>
    <a href="{{ url_for('transportista_quotas') }}">Cuotas</a>
    <a href="{{ url_for('transportista_history') }}">Historial</a>
  </nav>

  <script>
    // URL de la API (asumiendo que /api/choferes/mine ya existe en app.py)
    const API_URL = '{{ url_for("api_choferes_mine") }}';
    let choferes_data = {};

    // --- Funciones del Segmented Control (Género) ---
    function setupSegmentedControl(containerId, hiddenInputId) {
        const seg = document.getElementById(containerId);
        const hidden = document.getElementById(hiddenInputId);
        
        if (!seg || !hidden) return (val) => {};

        function updateState(val) {
            val = val || 'M';
            seg.querySelectorAll('button').forEach(b => {
                const isActive = b.getAttribute('data-val') === val;
                b.classList.toggle('active', isActive);
            });
            hidden.value = val;
        }

        seg.addEventListener('click', e => {
            if (e.target.tagName === 'BUTTON') {
                updateState(e.target.getAttribute('data-val'));
            }
        });
        return updateState;
    }

    // --- Lógica de Autocompletado (AJAX) ---

    // 1. Obtener y mapear datos de choferes
    async function fetchChoferes() {
        try {
            const response = await fetch(API_URL);
            if (!response.ok) throw new Error('Error de red al obtener choferes.');
            const data = await response.json();
            
            // Mapeamos los datos por DNI para acceso rápido
            data.forEach(c => {
                choferes_data[c.dni] = c;
            });
        } catch (error) {
            console.error("Error al obtener la lista de choferes:", error);
        }
    }

    // 2. Inicializar controles y fetch de datos
    const updateGender = setupSegmentedControl('gender-seg', 'gender-input');

    const dniInput = document.getElementById('dni-input');
    const nombreInput = document.getElementById('nombre-input');
    const tractorInput = document.getElementById('tractor-input');
    const trailerInput = document.getElementById('trailer-input');
    const tipoSelect = document.getElementById('tipo-select');

    // Cargar la lista de choferes al cargar la página
    fetchChoferes();


    // 3. Listener principal para el autocompletado
    dniInput.addEventListener('input', function() {
        const dni = this.value.trim();
        const chofer = choferes_data[dni];

        if (chofer) {
            // Rellenar campos
            nombreInput.value = chofer.nombre;
            tractorInput.value = (chofer.tractor || '').toUpperCase();
            trailerInput.value = (chofer.trailer || '').toUpperCase();
            
            // Si el tipo existe en el select, lo seleccionamos; si no, queda en "Tipo..."
            tipoSelect.value = chofer.tipo || ''; 
            
            // Actualiza los botones M/F
            updateGender(chofer.gender);
            
            // Movemos el foco para indicar que se complete
            nombreInput.focus(); 
        } else {
            // Limpiar si el DNI no coincide
            nombreInput.value = '';
            tractorInput.value = '';
            trailerInput.value = '';
            tipoSelect.value = ''; // Limpiar el tipo
            updateGender('M'); // Resetear género
        }
    });

    // 4. Patentes: mayúsculas, sin espacios
    document.querySelectorAll('.pat').forEach(inp=>{
      inp.addEventListener('input', ()=>{ inp.value = (inp.value || '').toUpperCase().replace(/\s+/g,''); });
    });
  </script>
</body>
</html>