<!doctype html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <title>Recepción | Arenera</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <style>
    :root {
      --bs-font-sans-serif: 'Inter', sans-serif;
      --bs-primary: #2563eb;
      --bs-body-bg: #f3f4f6;
      --bottom-nav-height: 70px;
    }

    body {
      font-family: var(--bs-font-sans-serif);
      background-color: var(--bs-body-bg);
      padding-bottom: calc(var(--bottom-nav-height) + 20px);
    }

    @media (min-width: 768px) {
      body { padding-bottom: 40px; }
    }

    /* --- TOP NAV --- */
    .top-nav {
      background: #fff; border-bottom: 1px solid #e5e7eb; padding: 0.8rem 0;
      display: none; box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    @media (min-width: 768px) { .top-nav { display: block; } }

    /* --- BOTTOM NAV --- */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0;
      height: var(--bottom-nav-height); background: #fff; border-top: 1px solid #e5e7eb;
      display: flex; justify-content: space-around; align-items: center;
      z-index: 1000; box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
    }
    .nav-item-link {
      display: flex; flex-direction: column; align-items: center;
      text-decoration: none; color: #9ca3af; font-size: 0.75rem; font-weight: 500; transition: color 0.2s;
    }
    .nav-item-link i { font-size: 1.5rem; margin-bottom: 4px; }
    .nav-item-link.active { color: var(--bs-primary); }
    @media (min-width: 768px) { .bottom-nav { display: none; } }

    /* --- SEARCH --- */
    .sticky-search {
      position: sticky; top: 0; z-index: 90;
      background: rgba(243, 244, 246, 0.95); backdrop-filter: blur(5px);
      padding: 10px 0; margin-bottom: 10px;
    }

    .form-control-dense {
      font-size: 0.9rem; padding: 0.4rem 0.6rem; border-radius: 6px;
      border-color: #d1d5db; text-align: center; font-weight: 600;
    }
    .form-control-dense:focus { border-color: var(--bs-primary); box-shadow: 0 0 0 2px rgba(37,99,235,0.1); }

    /* --- MOB CARD --- */
    .mob-card {
      background: #fff; border-radius: 12px;
      margin-bottom: 12px; padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.03);
      border: 1px solid #e5e7eb;
      position: relative; overflow: hidden;
    }
    .mob-card::before {
        content: ''; position: absolute; top: 0; bottom: 0; left: 0; width: 4px;
    }
    .st-viaje::before { background: #f59e0b; } 
    .st-salio::before { background: #10b981; } 
    .st-llego::before { background: #6b7280; } 

    .mob-head {
      display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;
    }
    .mob-title { font-weight: 700; color: #1f2937; font-size: 1rem; line-height: 1.2; }
    .mob-sub { font-size: 0.8rem; color: #6b7280; margin-top: 2px; }
    .mob-badge { font-size: 0.7rem; padding: 3px 8px; border-radius: 10px; font-weight: 700; text-transform: uppercase; }
    
    .badge-viaje { background: #fffbeb; color: #b45309; border: 1px solid #fcd34d; }
    .badge-salio { background: #ecfdf5; color: #047857; border: 1px solid #6ee7b7; }
    .badge-llego { background: #f3f4f6; color: #374151; border: 1px solid #d1d5db; }

    /* --- DESKTOP TABLE --- */
    .card-table {
      background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; 
      box-shadow: 0 2px 5px rgba(0,0,0,0.03); overflow: hidden;
    }
    .table-custom th {
      font-size: 0.75rem; text-transform: uppercase; color: #64748b; background: #f9fafb;
      padding: 12px 16px; border-bottom: 1px solid #e5e7eb; font-weight: 700;
    }
    .table-custom td {
      font-size: 0.9rem; vertical-align: middle; padding: 10px 16px; color: #334155;
      border-bottom: 1px solid #f1f5f9;
    }
    .table-custom tr:hover td { background-color: #f8fafc; }

    .btn-action {
      border: 1px solid #e5e7eb; background: #fff; color: var(--bs-primary);
      border-radius: 6px; padding: 6px 12px; font-weight: 700; font-size: 0.85rem;
      transition: all 0.2s;
    }
    .btn-action:hover { background: var(--bs-primary); color: #fff; border-color: var(--bs-primary); }
    
    .btn-undo { color: #ef4444; border-color: #fee2e2; background: #fff; }
    .btn-undo:hover { background: #fee2e2; color: #b91c1c; }

  </style>
</head>
<body>

  <div class="top-nav">
    <div class="container-xl d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
            <h5 class="m-0 fw-bold text-dark"><i class="fa-solid fa-truck-ramp-box text-primary me-2"></i>Recepción</h5>
        </div>
        <div class="d-flex gap-2">
          <a href="{{ url_for('arenera_history') }}" class="btn btn-outline-primary btn-sm fw-medium">
              <i class="fa-solid fa-clock-rotate-left me-1"></i> Historial
          </a>
          <a href="{{ url_for('change_password') }}" class="btn btn-sm text-secondary" title="Cambiar Contraseña">
              <i class="fa-solid fa-gear fa-lg"></i>
          </a>
          <a href="{{ url_for('logout') }}" class="btn btn-sm text-danger fw-medium" title="Cerrar Sesión">
            <i class="fa-solid fa-arrow-right-from-bracket"></i>
          </a>
        </div>
    </div>
  </div>

  <div class="d-md-none px-3 pt-3 pb-2 d-flex justify-content-between align-items-center bg-body">
      <div>
        <h1 class="h5 fw-bold m-0">Recepción</h1>
        <small class="text-muted">{{ user.username }}</small>
      </div>
      <div>
          <a href="{{ url_for('change_password') }}" class="text-secondary me-3"><i class="fa-solid fa-gear"></i></a>
          <a href="{{ url_for('logout') }}" class="text-danger"><i class="fa-solid fa-power-off"></i></a>
      </div>
  </div>

  <div class="container-xl">

    <div class="sticky-search">
        <form method="get" action="{{ url_for('arenera_panel') }}">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
            <input type="hidden" name="status" value="En viaje">
            
            <div class="row g-2">
                <div class="col-7 col-md-9">
                    <div class="input-group input-group-sm shadow-sm">
                        <span class="input-group-text bg-white border-end-0 ps-3"><i class="fa-solid fa-magnifying-glass text-muted"></i></span>
                        <input type="text" name="search" class="form-control border-start-0" 
                               placeholder="Patente, chofer..." value="{{ stats.search }}" autocomplete="off">
                        {% if stats.search %}
                            <a href="{{ url_for('arenera_panel') }}" class="btn btn-white border-top border-bottom border-end"><i class="fa-solid fa-xmark"></i></a>
                        {% endif %}
                    </div>
                </div>
                <div class="col-5 col-md-3">
                    <select name="trans_filter" class="form-select form-select-sm shadow-sm" onchange="this.form.submit()">
                        <option value="">Todos</option>
                        {% if active_transports %}
                            {% for t in active_transports %}
                                <option value="{{ t.id }}" {{ 'selected' if stats.trans_filter|string == t.id|string else '' }}>{{ t.username }}</option>
                            {% endfor %}
                        {% endif %}
                    </select>
                </div>
            </div>
        </form>
    </div>

    <div class="d-none d-md-block">
        <div class="card-table">
            <div class="table-responsive">
                <table class="table table-custom mb-0">
                    <thead>
                        <tr>
                            <th style="width: 50px;">ID</th>
                            <th style="width: 20%;">Chofer</th>
                            <th style="width: 15%;">Patente</th>
                            <th style="width: 20%;">Transportista</th>
                            <th style="width: 15%;">Remito Salida</th>
                            <th style="width: 15%;">Peso Salida (Tn)</th>
                            <th style="width: 100px;" class="text-end">Acción</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for s in shipments %}
                        <tr>
                            <td class="fw-bold text-muted">#{{ s.id }}</td>
                            <td>
                                <div class="fw-bold text-dark">{{ s.chofer }}</div>
                                <div class="small text-muted" style="font-size:0.75rem;">DNI: {{ s.dni }}</div>
                            </td>
                            <td class="font-monospace text-primary fw-bold">{{ s.tractor }}</td>
                            <td class="text-muted">{{ s.transportista.username }}</td>

                            <td colspan="3" style="padding:0;">
                                <form method="post" action="{{ url_for('arenera_update', shipment_id=s.id) }}" 
                                      style="display:contents;" 
                                      onsubmit="return validateWeight(event, this)">
                                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                    
                                    <div style="display:flex; align-items:center; padding:8px 12px; gap:10px;">
                                        <div style="flex:1;">
                                            <input type="text" name="remito_arenera" 
                                                class="form-control form-control-sm form-control-dense" 
                                                placeholder="N°" value="{{ s.remito_arenera or '' }}"
                                                {{ 'readonly' if s.status != 'En viaje' else '' }}>
                                        </div>
                                        <div style="flex:1;">
                                            <input type="number" step="0.01" name="peso_neto_arenera" 
                                                class="form-control form-control-sm form-control-dense" 
                                                placeholder="00.00" value="{{ s.peso_neto_arenera if s.peso_neto_arenera is not none else '' }}"
                                                {{ 'readonly' if s.status != 'En viaje' else '' }}>
                                        </div>
                                        <div style="width:100px; text-align:right;">
                                            {% if s.status == 'En viaje' %}
                                                <button type="submit" name="action" value="confirmar_salida" class="btn-action">
                                                    <i class="fa-solid fa-check me-1"></i>Salió
                                                </button>
                                            {% elif s.status == 'Salió' %}
                                                 <button type="submit" name="action" value="revertir" class="btn btn-sm btn-undo" title="Corregir">
                                                    <i class="fa-solid fa-rotate-left"></i>
                                                </button>
                                            {% else %}
                                                <span class="badge bg-secondary">Llegó</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </form>
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="7" class="text-center py-5 text-muted">No hay camiones en espera.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="d-md-none">
        {% if shipments %}
            {% for s in shipments %}
            <div class="mob-card {{ 'st-salio' if s.status == 'Salió' else ('st-llego' if s.status == 'Llego' else 'st-viaje') }}">
                
                <div class="mob-head">
                    <div>
                        <div class="mob-title">{{ s.chofer }}</div>
                        <div class="mob-sub">
                            {{ s.transportista.username }} • <span class="font-monospace text-dark">{{ s.tractor }}</span>
                        </div>
                    </div>
                    
                    {% if s.status == 'Salió' %}
                        <span class="mob-badge badge-salio">Salió</span>
                    {% elif s.status == 'Llego' %}
                        <span class="mob-badge badge-llego">Llegó</span>
                    {% else %}
                        <span class="mob-badge badge-viaje">En Viaje</span>
                    {% endif %}
                </div>

                <form method="post" action="{{ url_for('arenera_update', shipment_id=s.id) }}" 
                      class="mt-3"
                      onsubmit="return validateWeight(event, this)">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                    
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <input type="text" name="remito_arenera" class="form-control form-control-dense" 
                                   placeholder="Remito" value="{{ s.remito_arenera or '' }}"
                                   {{ 'readonly' if s.status != 'En viaje' else '' }}>
                        </div>
                        <div class="col-6">
                            <input type="number" step="0.01" name="peso_neto_arenera" class="form-control form-control-dense" 
                                   placeholder="Kg" value="{{ s.peso_neto_arenera if s.peso_neto_arenera is not none else '' }}"
                                   {{ 'readonly' if s.status != 'En viaje' else '' }}>
                        </div>
                    </div>

                    <div class="d-grid">
                        {% if s.status == 'En viaje' %}
                            <button type="submit" name="action" value="confirmar_salida" class="btn btn-primary fw-bold shadow-sm">
                                Confirmar Salida
                            </button>
                        {% elif s.status == 'Salió' %}
                            <button type="submit" name="action" value="revertir" class="btn btn-outline-danger btn-sm">
                                <i class="fa-solid fa-rotate-left me-2"></i>Corregir
                            </button>
                        {% endif %}
                    </div>
                </form>
            </div>
            {% endfor %}
            
            <div class="text-center mt-4 mb-4 text-muted small opacity-50">
                --- Fin de la lista ---
            </div>

        {% else %}
            <div class="text-center py-5">
                <div class="bg-white p-3 rounded-circle shadow-sm d-inline-block mb-3">
                    <i class="fa-solid fa-road fa-2x text-muted opacity-25"></i>
                </div>
                <h6 class="fw-bold text-secondary">Sin camiones</h6>
                <p class="text-muted small">Los viajes aparecerán aquí cuando el transportista los cargue.</p>
                <a href="{{ url_for('arenera_panel') }}" class="btn btn-sm btn-outline-primary">Actualizar</a>
            </div>
        {% endif %}
    </div>

  </div>

  <nav class="bottom-nav">
    <a href="{{ url_for('arenera_panel') }}" class="nav-item-link active">
        <i class="fa-solid fa-truck-ramp-box"></i>
        <span>Recepción</span>
    </a>
    <a href="{{ url_for('arenera_history') }}" class="nav-item-link">
        <i class="fa-solid fa-clock-rotate-left"></i>
        <span>Historial</span>
    </a>
  </nav>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            Swal.fire({
              toast: true, position: 'top', icon: "{{ 'success' if category in ['ok','success'] else 'info' }}",
              title: "{{ message }}", showConfirmButton: false, timer: 2000
            });
          {% endfor %}
        {% endif %}
      {% endwith %}
    });

    // Validar peso "Raro" (<25 o >37 Tn)
    function validateWeight(event, form) {
        const weightInput = form.querySelector('input[name="peso_neto_arenera"]');
        
        // Si no hay input o es solo lectura (caso revertir), pasamos
        if (!weightInput || weightInput.readOnly) return true;

        const weight = parseFloat(weightInput.value);
        if (isNaN(weight)) return true; // Backend validará

        if (weight < 25 || weight > 37) {
            event.preventDefault(); // Detener envío
            
            Swal.fire({
                title: 'Verificación de Peso',
                text: `Ingresaste ${weight} Tn. ¿Estás seguro?`,
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#2563eb',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, es correcto',
                cancelButtonText: 'Revisar'
            }).then((result) => {
                if (result.isConfirmed) {
                    // Agregar el action manualmente porque submit() programático no envía el botón pulsado
                    const hiddenAction = document.createElement('input');
                    hiddenAction.type = 'hidden';
                    hiddenAction.name = 'action';
                    hiddenAction.value = 'confirmar_salida';
                    form.appendChild(hiddenAction);
                    
                    form.submit();
                }
            });
            return false;
        }
        return true;
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>